\section{Методология}
\label{section:methodology}

%В данном разделе описана методология определения параметров маргинальных распределений и копул. Сформулирована задача оптимизации портфеля. Далее описан алгоритм оценки риска портфеля с использованием копулярных моделей, а также приведен алгоритм бутстрап-процедуры. %# для ... .

\subsection{Подготовка исходных данных} 
\label{methodology:preparing}

В первую очередь, имеющиеся исходные данные, представляющие собой временные ряды, необходимо преобразовать в логарифмические доходности. 
Таким образом мы получим %#устойчивый 
набор данных, который %#мы в дальнейшем 
будем использовать для оценки параметров %№фитинга 
частных (маргинальных) распределений и параметров копул. Уравнение~(\ref{log-returns}) преобразует ряд дневных цен закрытия активов $p_i$ в ряд дневных лог-доходностей $r_i$ для каждого актива $i$:
%
\begin{equation}\label{log-returns}
r_{t,i}=\log \frac{p_{t,i}}{p_{t-1,i}},
\end{equation}

\noindent где $i \in \overline{1, d}$, $d$ -- количество активов в портфеле, $t\in \overline{1, T}$ -- время в днях.

Финансовые временные ряды, %#с которыми я работаю, 
как правило, имеют нелинейную зависимость друг с другом.
Как известно, обычная линейная корреляция Пирсона не отражает нелинейную зависимость между величинами.
Поэтому для оценки параметров копул необходимо использовать коэффициенты ранговой корреляции, например, $\tau$ Кендалла \cite{Kendall1970} или $\rho$ Спирмена \cite{Mye2003}.

Пусть $X$ и $Y$ -- две случайные величины, определённые на одном и том же вероятностном пространстве, %# уточнить математически
тогда коэффициент ранговой корреляции Спирмена %№-- $\rho$ -- 
определяется из уравнения:
%
\begin{equation}\label{spearman}
\rho = r(\text{rg}_X, \text{rg}_Y) = \frac{\text{cov}(\text{rg}_{X},\text{rg}_{Y})}{\sigma_{rg_X} \sigma_{rg_Y}},
\end{equation}

\noindent где $r(\cdot)$ -- обычный линейный коэффициент корреляции Пирсона, применённый к значениям  рангов случайных величин $\text{rg}_X$ и $\text{rg}_Y$,  $\text{cov} (\text{rg}_{X}, \text{rg}_{Y})$ и $\sigma$ -- ковариация между этими рангами и стандартное отклонения рангов соответственно~\cite{Mye2003}.

Для двух независимых пар $(X_a, X_b)$ и $(Y_a, Y_b)$ некоторых случайных величин $X$ и $Y$ можно также вычислить %#$\tau$ --
коэффициент ранговой корреляции Кендалла:
%
\begin{eqnarray}\label{kendall}
\tau &=& P\big[(X_a-X_b)(Y_a-Y_b)>0\big]-P\big[(X_a-X_b)(Y_a-Y_b)<0\big] = \\ 
&=& r\big(\text{sgn}(X_a-X_b),\text{sgn}(Y_a-Y_b)\big),\nonumber
\end{eqnarray}

\noindent где $r(x,y)$ также корреляция Пирсона \cite{Kendall1970}, a $sgn(\cdot)$ -- функция взятия знака вещественного числа.

Оба выбранных коэффициента ранговой корреляции, в отличие от линейной корреляции Пирсона, намного менее чувствительны к сильным отклонениям, постоянно возникающим в динамике финансовых рядов.
Это происходит потому, что отклонения и выбросы ограничиваются коэффициентами $\rho$ Спирмена и $\tau$ Кендалла до значения их ранга \cite{Ane2003}.
Согласно статье \cite{Dissmann2013}, в дальнейших вычислениях будем использовать $\tau$ Кендалла.

\subsection{Оценка параметров маргинальных распределений}
\label{methodology:marginals}

Сегодня существует множество различных методов применения Гауссового распределения для описания финансовых данных \cite{Json1949}. 
С другой стороны, множество эмпирических исследований показало \cite{Limp2011, Rachev2005, Wilmott2007}, что использование данного распределения пересекается с множеством проблем, возникающих при описании финансовых временных рядов. 
Для моделирования экстремальных событий предложены различные распределения, отражающие свойства финансовых рядов, которые невозможно описать нормальным распределением.
В данной работе мы использовали в качестве кандидатов следующие маргинальные распределения: гиперболическое \cite{Barndoff1983}, устойчивое Парето \cite{Nolan2009, Rachev2005, Stoyanov2013} и Мейкснера \cite{Schoutens2002}. Эти распределения имеют важные параметры, определяющие фундаментальные свойства финансовых рядов, которые не описываются нормальным распределением, а именно: тяжёлые хвосты и асимметрия \cite{Stoyanov2013}. 

Приведем краткое описание указанных распределений.
Гиперболическое распределение определяется четырьмя параметрами: $\pi$ показывает крутизну, $\zeta$ -- асимметрию, $\mu$ определяет сдвиг и $\delta$ -- масштаб. 
Распределение симметрично относительно параметра сдвига $\mu$ при параметре асимметрии $\zeta=0$. 
Уравнение~(\ref{hpdf}) описывает функцию распределения вероятности гиперболического распределения:

\begin{eqnarray}\label{hpdf} 
f_H(x|\pi,\zeta,\delta,\mu)=\frac{1}{2 \sqrt{1+\pi^2} 
K_1(\zeta) }e^{-\zeta \left[ \sqrt{1+\pi^2}
\sqrt{1+\big(\frac{x-\mu}{\delta})^2}-
\pi\frac{x-\mu}{\delta}\right]},
\end{eqnarray}

\noindent где $K_1(x)$ -- модифицированная функция Бесселя третьего рода 1-го порядка \cite{Bessel1824}, $\pi \in \mathbb{R}$, $\zeta > 0$, $\delta > 0$, $\mu \in \mathbb{R}$.

Устойчивое распределение Парето также описывается четырьмя параметрами: $\alpha$ определяет тяжесть хвостов и эксцесс, $\beta$ -- асимметрию, $\gamma$ является параметром масштаба, а $\mu$ -- сдвига. Так как для данного распределения в аналитической форме не существует ни кумулятивной функции, ни функции плотности распределения вероятности, принято использовать характеристическую функцию:
%
\begin{eqnarray}\label{StChF} 
\varphi_S(x|\alpha,\beta,\gamma,\delta) &=& \exp{\left[ix\delta-|\gamma x|^\alpha \left(1 - i\beta\text{sgn}(x)\Upphi(x)\right)\right]}, \\
\Upphi(x) &=& \left\{ \begin{aligned}
    & \left(|\gamma x|^{1-\alpha} - 1\right)\tan{\frac{\pi\alpha}{2}}, & & \alpha \ne 1, \\
    & -\frac{2}{\pi}\log{|\gamma x|}, & & \alpha = 1,
\end{aligned} \right. \nonumber
\end{eqnarray}

\noindent где $\alpha \in (0;\ 2]$, $\beta \in [-1;\ 1]$, $\gamma > 0$, $\delta \in \mathbb{R}$, $i$ -- мнимая единица.

Распределение Мейкснера задаётся следующими четырьмя параметрами: $\alpha$ -- параметр масштаба, $\beta$ -- асимметрии, $\delta$ -- формы, $\mu$ -- сдвига. Плотность распределения Мейкснера описывается следующим уравнением:
%
\begin{equation} \label{mpdf}
    f_M(x|\alpha,\beta,\delta,\mu)=\frac{\left(2\cos{\frac{\beta}{2}}\right)^{2\delta}}{2\alpha\pi\Upgamma(2\delta)}\exp{\frac{\beta(x-\mu)}{\alpha}}\left|\Upgamma\left(\delta + i\frac{x-\mu}{\alpha}\right)\right|^2,
\end{equation}

\noindent где $\Upgamma(z)$ -- гамма-функция для комплексных аргументов, $\alpha > 0$, $|\beta| < \pi$, $\delta > 0$, $\mu \in \mathbb{R}$.

Для оценки параметров гиперболического распределения можно воспользоваться методом Нелдера\,--\,Мида, устойчивого Парето и распределения Мейкснера -- критерием омега-квадрат, он же метод дистанции Крамера\,--\,фон~Мизеса. 
Для оценки качества полученных параметров будем использовать тесты Колмогорова\,--\,Смирнова, а также Андерсона\,--\,Дарлинга и Крамера\,--\,фон~Мизеса. 
В этих тестах будем сравнивать эмпирические наблюдения, т.~е. непосредственно реальные лог-доходности, со значениями модельных данных полученных с использованием указанных распределений.


\subsection{Оценка параметров копулярных моделей}
\label{methodology:copula}

На данном этапе необходимо сконструировать копулу, используя два вида копулярных моделей: обычную многомерную и регулярную вайн-копулу. 
Сначала необходимо исходные лог-доходности активов инвестиционого портфеля перевести в пространство области определения копулы, то есть в единичный гиперкуб: $$\mathbb{R}^d \to [0, 1]^d.$$ Таким образом мы построим  эмпирическую копулу по  \boldit{псевдо\-наблюдения}. 
Пусть из уравнения (\ref{log-returns}) мы имеем ряд лог-доходностей $\boldsymbol{r}_i = (r_{1,i}, \ldots, r_{T,i})^\intercal$ для всех исторических наблюдений каждого актива $i \in \overline{1,d}$, тогда псевдо-наблюдения будут определяться из следующей формулы:
%
\begin{equation} \label{pobs}
    u_{t,i} = \frac{\text{rg}(r_{t,i})}{T + 1},\ \forall \ t \in \overline{1,T},\ i \in \overline{1,d},
\end{equation}

\noindent где $\text{rg}(r_{t,i})$ -- ранг $r_{t,i}$ (от наименьшего к наибольшему) по отношению к наблюдаемым значениям $r_{\tau,i}, \tau \in \overline{1,T}$ \cite{Copula}. Каждое псевдо-наблюдение $u_{t,i}$ находится между 0~и~1.

В данной работе мы использовали два вида копул-функций:

\begin{enumerate}[label=(\arabic*),labelwidth=1cm,leftmargin=1cm]
\item $d$-мерная копула $C$ называется \textit{эллиптической}, если функция её распределения удовлетворяет уравнению:
\begin{equation} \label{EllipCop}
    C(u_1, u_2, \ldots,u_d|\theta) = F_d(F^{-1}(u_1|\theta),F^{-1}(u_2|\theta), \ldots,F^{-1}(u_d|\theta)|\theta),
\end{equation}
где $F(x)$ кумулятивная функция маргинального распределения, $F^{-1}(p)$ -- обратная функция распределения, $F_d(x_1,x_2,\dots,x_d)$ -- кумулятивная функция $d$-мерного совместного распределения, $\theta$ -- вектор параметров.

\item $d$-мерная копула $C$ называется \textit{архимедовой}, если функция её распределения удовлетворяет уравнению:
\begin{equation} \label{ArchCop}
    C(u_1,u_2,\ldots,u_d|\theta) = \psi^{[-1]}(\psi(u_1|\theta)+\psi(u_2|\theta) + \ldots + \psi(u_d|\theta) | \theta ),
\end{equation}
где $\psi$: $[0,1] \rightarrow [0, \infty]$ -- непрерывная строго убывающая выпуклая функция такая, что $\psi(1)=0$, также называемая \textit{функцией-генератором}, а $\psi^{[-1]}(p)$ -- псевдо-обратная функция, определяемая из уравнения:
$$\psi^{[-1]}(p) = \left\{ \begin{aligned}
    & \psi^{-1}(p),    & \ 0 \le p & \le \psi(0), \\
    & 0,                  & \ \psi(0) \le p & \le \infty.
\end{aligned} \right.$$
\end{enumerate}

В данной работе мы использовали два вида эллиптических копул: Гауссову и $t$\,--\,Стьюдента и, соответственно, Гауссово и Стьюдента совместное многомерное распределение, т.~к. они наиболее часто используются применительно к финансовым данным~\cite{Lourme2016}.

В общем случае $d$-мерная Гауссова копула с корреляционным параметром $\rho$ описывается как
\begin{equation} \label{nCop}
C_{Gauss}(u_1,u_2,\ldots,u_d|\rho) = \Upphi_d \left( \Upphi^{-1} (u_1), \Upphi^{-1} (u_2), \ldots, \Upphi^{-1} (u_d) | \rho \right),
\end{equation}
где $\Upphi_d(x_1,x_2,\dots,x_d)$ и $\Upphi^{-1}(p)$ -- кумулятивная и обратная функции $d$-мерного совместного Гауссового распределения соответственно, $\rho \in (-1, 1)$ \cite{Emb2001}. 
В общем случае для многомерной Гауссовой копулы корреляционным параметром $\rho$ является корреляционная матрица $\Upsigma$, описывающая зависимость между входными переменными.

В общем случае $d$-мерная $t$-копула с корреляционным параметром $\rho$ и числом степеней свободы равным $\nu$ описывается как
\begin{equation} \label{tCop}
C_{t}(u_1,u_2,\ldots,u_d|\rho, \nu) = t_d \left( t^{-1} (u_1|\nu), t^{-1} (u_2|\nu), \ldots, t^{-1} (u_d|\nu) | \rho, \nu \right),
\end{equation}
где $t_d(x_1,x_2,\dots,x_d)$ и $t^{-1}(p)$ -- кумулятивная и обратная функции $d$-мерного совместного $t$-распределения соответственно, $\rho \in (-1, 1)$, $\nu \ge 2$ \cite{Emb2001}. 
Корреляционным параметром $\rho$ в многомерной копуле Стьюдента также является корреляционная матрица $\Upsigma$.

Другой вариант построения зависимости -- использование R-vine копул. Как известно из \cite{Bedfort2002}, $d$-мерная вайн копула -- это конструкция, построенная из $d(d - 1)/2$ обычных двумерных копул. Структура этой конструкции определяется набором связанных деревьев $\mathcal{V} = (T_1, T_2, \ldots, T_ {d-1})$ по следующим правилам:

\begin{enumerate}[label=(\roman*),labelwidth=1cm,leftmargin=1cm]
\item $T_1 = (V_1,E_1)$ -- дерево дерево с узлами $V_1 = \{1, 2, \ldots, d\}$ и ребрами $E_1$. 
Это дерево является графом, в котором любые два узла связаны уникальной ветвью \cite{Diestel2005}.

\item Для $m = 2,3,\ldots,d - 1$ дерево $T_m$ состоит из узлов $V_m = E_{m-1}$ и ребер $E_m$.

\item \label{iii} Для $m = 2,3,\ldots,d - 1$ два узла дерева $T_m$ могут быть связаны ребром только в случае, если соответствующие ребра дерева $T_{m-1}$ имеют общий узел.
\end{enumerate}

Пусть $c_{j_e,k_e;D_e}$ -- двумерная (парная) копула для каждого ребра $e$ в некотором из $d - 1$ деревьев вайн копулы \cite{Czado2010}. Обозначим через $j_e$ и $k_e$ индексы условных переменных $U_{j_e}$ и $U_{k_e}$. Также обозначим через $D_e$ условную выборку, соответствующую ребру $e$. Таким образом, $c_{j_e,k_e;D_e}$ -- плотность распределения копулы для двух случайных величин $U_{j_e|D_e}$ и $U_{k_e|D_e}$, где $U_{i|D} = C_{i|D} (U_i|U_D)$. Таким образом, плотность вайн копулы представлена уравнением
%
\begin{equation}
    c(u_1, \ldots, u_d) = \prod_{m=1}^{d-1} \prod_{e \in E_m} c_{j_e,k_e;D_e} \left( C_{j_e|D_e} (u_{j_e}|\textbf{u}_{D_e}), C_{k_e|D_e} (u_{k_e}|\textbf{u}_{D_e}); \textbf{u}_{D_e} \right).
\end{equation}
%# проверить жирное и заглавное написание векторов и переменных

Вайн структура, в которой все узлы соединены последовательно, называется $D$-vine, тогда как деревья с звездо-образной структурой называются $C$-vine \cite{Dissmann2013}. 
Мы используем $R$-vine (\textit{regular vine}) структуру, представляющую собой комбинацию двух вышеописанных типов. 
Такая структура является наиболее общим примером максимально покрывающего дерева.
Главное преимущество вайн копул в том, что каждый её компонент представляет собой парную копулу с независимым от других компонентов распределением.
Такие копулы легче интерпретировать и визуализировать, сегодня существует множество методом для работы с ними \cite{Cooke2015, Czado2010, Dissmann2013}. 
К тому же за счёт возможности выбора разных распределений для каждой парной копулы резко увеличивается гибкость данных моделей копул.

Основываясь на исследование \cite{Dissmann2013}, мы использовали абсолютное эмпирическое значение $\tau$ Кендалла в качестве меры зависимости, т.~к. эта мера не зависит от предполагаемого распределения и, следовательно, особенно полезна на шаге \ref{iii}.
%# добавить ссылку на номер страницы
Заметим, что для вайн копул в качестве параметра допустимо использование вещественное значение степеней свободы. %# у копул с двумя параметрами. 
К тому же мы используем разные семейства распределений для каждой парной копулы \cite{Bel2010}.

Рассмотрим наиболее распространённые семейства парных копул. 
Для начала приведём общую формулу, преобразовав уравнение~(\ref{EllipCop}) для двумерного случая:
\begin{equation} \label{BiArch}
    C(u,v|\theta,\delta) = \varphi (\varphi^{-1}(u|\theta,\delta) + \varphi^{-1}(v|\theta,\delta)|\theta,\delta).
\end{equation}

В статье \cite{Brechmann2013} можно также найти общие формулы для приведения функции двумерной копулы к её <<повёрнутой>> версии:
\begin{equation} \label{rotatedCop}
\begin{aligned}
    C_{90}(u,v) &= v - C(1 - u, v), \\
    C_{180}(u,v) &= u + v - 1 + C(1 - u,1 - v), \\
    C_{270}(u, v) &= u - C(u, 1 - v),
\end{aligned}
\end{equation}
число в индексе обозначает угол поворота в градусах.

Теперь кратко рассмотрим некоторые из семейств двумерных копул, описанных в монографии Г.~Джо \cite{Joe1997}.

\begin{enumerate}
\item \textbf{Копула Клейтона}.\\
Рассмотрим уравнеие~(\ref{BiArch}) при $0 \le u,v,t \le 1$ и $\delta \ge 0$, где
\begin{equation}
\begin{aligned}
    \varphi (s) = \varphi(s| \delta) &= (1 + s \delta)^{-1/\delta}, \\ 
    \varphi^{-1}(t| \delta) &= \frac{1}{\delta} (t^{-\delta} - 1)^\delta,
\end{aligned} \nonumber 
\end{equation}
тогда
\begin{equation}
    C(u,v|\delta) = (u^{-\delta} + v^{-\delta} - 1)^{-1/\delta}. \nonumber
\end{equation}
Уравнение~(\ref{rotatedCop}) преобразует копулу Клейтона в <<Survival>> копулу Клейтона, т.е. копулу Клетона, повёрнутую на 180º.

\item \textbf{Копула Гумбеля}.\\
Рассмотрим уравнение (\ref{BiArch}) при $0 \le u,v,t \le 1$ и $\delta \ge 1$, где
\begin{equation}
\begin{aligned}
    \varphi (s) = \varphi(s| \delta) &= \exp{\{-s^{1/\delta}\}}, \\ 
    \varphi^{-1}(t| \delta) &= (-\log{t})^\delta,
\end{aligned} \nonumber 
\end{equation}
тогда
\begin{equation}
    C(u,v|\delta) = \exp{\left\{-([-\log{u}]^\delta + [-\log{v}]^\delta)^{1/\delta}\right\}}. \nonumber
\end{equation}
Уравнение (\ref{rotatedCop}) преобразует копулу Гумбеля в <<Survival>> копулу Гумбеля (копула Гумбеля, повёрнутая на 180º). 

\item \textbf{Копула Клейтона-Гумбеля (BB1)}.\\
Рассмотрим уравнение (\ref{BiArch}) при $0 \le u,v,t \le 1$, $\theta > 0$ и $\delta \ge 1$, где
\begin{equation}
\begin{aligned}
    \varphi (s) = \varphi(s| \theta, \delta) &= (1 + s^{1/\delta})^{-1/\theta}, \\ 
    \varphi^{-1}(t| \theta, \delta) &= (t^{-\theta} - 1)^\delta,
\end{aligned} \nonumber 
\end{equation}
тогда
\begin{equation}
    C(u,v|\theta,\delta) = \left\{1 + [(u^{-\theta} - 1)^\delta + (v^{-\theta} - 1)^\delta]^{1/\delta} \right\}^{-1/\theta}. \nonumber
\end{equation}
Уравнение (\ref{rotatedCop}) преобразует BB1 копулу в  <<Survival>> копулу Клейтона-Гумбеля (BB1 копула, повёрнутая на 180º).

% \item \textbf{Копула Джо-Клейтона (BB7)}.\\
% Рассмотрим ур.~(\ref{BiArch}) при $0 \le u,v,t \le 1$, $\theta \ge 1$ и $\delta > 0$, где
% \begin{equation}
% \begin{aligned}
%     \varphi (s) = \varphi(s| \theta, \delta) &= 1-[1-(1+s)^{-1/\delta}]^{1/\theta}, \\
%     \varphi^{-1}(t| \theta, \delta) &= [1-(1-t)^\theta]^{-\delta} - 1,
% \end{aligned} \nonumber 
% \end{equation}
% тогда
% \begin{equation}
%     C(u,v|\theta,\delta) = 1 - \left( 1 - \left[(1 - u^{-\theta})^{-\delta} + (1 - v^{-\theta})^{-\delta} - 1 \right]^{-1 / \delta} \right)^{1 / \theta}. \nonumber
%     \end{equation}

\item \textbf{Копула Франка}.\\
Рассмотрим уравенение (\ref{BiArch}) при $0 \le u,v,t \le 1$, $\theta \ge 1$ и $-\infty < \delta < \infty$, где
\begin{equation}
\begin{aligned}
    \varphi (s) = \varphi(s| \delta) &= -\delta^{-1}\log{[1-(1-e^{-\delta})e^{-s}]}, \\
    \varphi^{-1}(t| \delta) &= -\log{[(1-e^{-\delta t})/(1-e^{-\delta})]},
\end{aligned} \nonumber 
\end{equation}
тогда
\begin{equation}
    C(u,v|\delta) = -\delta^{-1} \log{\left(\frac{1 - e^{-\delta} - (1 - e^{-\delta u})(1 - e^{-\delta v})}{1 - e^{-\delta}}\right)}. \nonumber
    \end{equation}

\item Также стоит отметить \boldit{независимую копулу}, описанную впервые в монографии \cite{Nelsen1999}. 
Эта копула соответствует случаю, когда входные величины $u$ и $v$ независимы:
\begin{equation}
    C(u,v) = uv. \nonumber
\end{equation} 
\end{enumerate}
%
Детальную информацию по другим семействам можно найти в монографиях~\cite{Joe2014, Nelsen1999}.

Для оценки параметров копул мы использовали псевдо-наблюдения, вычисленные по формуле~(\ref{pobs}). 
Выбор наиболее подходящего семейства определяется из тестов Вуонга и Кларка \cite{Clarke2007, Vuong1989}. 
Основание для выбора параметров копулы определяется согласно методу <<Инверсии $\tau$ Кендалла>> \cite{Koj2010}. 

Для проверки адекватности полученных моделей выполняется параметрический загрузочный тест оценки качества фитинга (\textit{goodness-of-fit} тест) найденных параметров эллиптических копул \cite{Gen2009}.
В данной работе используется два GoF-теста: (1) для тестирования Гауссовой и Стьюдента копул в качестве статистики используется функционал Крамера\,--\,фон~Мизеса $S_n$ \cite{Gen2009}, а (2) для проверки параметров вайн копулы используется матричное уравнение информационного критерия Уайта, $W$ \cite{White1982}.


\subsection{Построение оптимального инвестиционного портфеля} 

Сформулируем задачу
оптимизации для построения модельного портфеля. В качестве целевой
функции задачи оптимизации мы использовали минимизацию величины
ожидаемых потерь $CVaR_\alpha$, которую
реальные потери не превысят с вероятностью $\alpha$: % (уровень для
%вычисления VaR и CVaR):
\begin{gather} \label{ES}
    \underset{\textbf{w}}{\min} \, CVaR_\alpha =
    \underset{\textbf{w}}{\min} \, \mathbb{E}\left\{\mu_p | \mu_p \le - VaR_\alpha
    \right\},
\end{gather}
здесь ожидаемая доходность портфеля
\begin{gather*}
\mu_p = \sum_{i=1}^d \mu_i w_i,
\end{gather*}
$\textbf{w}=(w_1, w_2, \ldots, w_d)$ -- вектор долей $i$-го актива в
портфеле. Согласно работе~\cite{Rock2000} мера риска $VaR_\alpha$ для
портфеля с ожидаемой доходностью $\mu_p$ определяется из формулы
%
\begin{gather*} \label{VaR}
    VaR_\alpha = \min\left\{\zeta \in \mathbb{R}|P(\mu_p \le \zeta) \ge \alpha \right\},
\end{gather*}
здесь $\zeta$ -- некоторое значение случайной величины $\xi$,
поставленной в соответствие доходности портфеля $\mu_p$.

%CVaR -- \textit{Conditional-Value-at-Risk}, также называемого
%\textit{Expected Shortfall} (ES), или \textit{Expected Tail Loss}
%(ETL).
%Данная величина равна ожидаемому объёму потерь, который реальные
%потери не превысят с вероятностью $\alpha$ -- т.~н. уровень для
%вычисления VaR и CVaR.

Ограничения в задаче оптимизации портфеля сформулируем в виде:
\begin{subequations}\label{conES}
\begin{align}
\sum_{i=1}^d \mu_i w_i &\ge \bar{\mu}_p, \label{conES1}\\
\sum_{i=1}^d w_i &= 1, \label{conES2} \\
w_i &\ge 0, \quad \forall i. \label{conES3}
\end{align}
\end{subequations}
%
В данной формулировке ограничение~(\ref{conES1}) определяет
условие на минимальную доходность оптимального портфеля,
обозначенную $\bar{\mu}_p$, ограничение~(\ref{conES2}) --
доступные денежные средства должны быть инвертированы полностью,
ограничение~(\ref{conES3}) накладывает запрет на позиции без
покрытия (короткие позиции).

Таким образом, решением задачи (\ref{ES})-(\ref{conES}) будет
структура портфеля $\textbf{w}=(w_1, w_2, \ldots, w_d)$ с минимальным значением ожидаемых потерь
$CVaR_\alpha$ и доходностью не меньше, чем значение $\bar{\mu}_p$.
Задача~(\ref{ES})-(\ref{conES}) %(\ref{conES3})
представляет собой задачу линейного программирования
\cite{Rock2000}, следовательно, можно найти портфель с минимальным
$VaR_\alpha$ для заданного уровня~$\alpha$.


%\subsection{Оптимизация портфеля}

%В качестве задачи оптимизации портфеля мы используем минимизацию CVaR -- \textit{Conditional-Value-at-Risk}, также называемого \textit{Expected Shortfall} (ES) или \textit{Expected Tail Loss} (ETL). 
%Данная величина равна ожидаемому объёму потерь, который реальные потери не превысят с вероятностью $alpha$ (уровень для вычисления VaR и CVaR).
%Преимущество такой задачи состоит в том, что нахождение её решения является задачей линейного программирования~\cite{Rock2000}. 
%А поскольку мы можем найти портфель с минимальным CVaR, следовательно, можно найти портфель с минимальным VaR. 

%Обозначим за $\mu$ ожидаемое значение случайной величины, т.~е. ставку лог-доходности, причём $\mu_i = \mathbb{E}(r_i), i \in \overline{1,d}$. 
%Положим, что наш портфель состоит из $d$ активов. 
%Каждому $i$-му активу поставим в соответствие его долю в портфеле $w_i \in \textbf{w}$, где \textbf{w} -- вектор долей портфеля, определяющий его структуру. 
%Также введём запрет на короткие позиции и введём ограничение, согласно которому сумма долей портфеля равна единице.
%Пусть $V$ -- ковариационная матрица, определяющая зависимость между активами.
%Тогда ожидаемая доходность $\mu_p$ и $\sigma_p$ риск портфеля выражаются через уравнения
%
%\begin{gather}\label{portretandrisk}
%\mu_p = \sum_{i=1}^d \mu_i w_i,\\
%\sigma_p^2 = \textbf{w}^\intercal \text{V} \textbf{w}.
%\end{gather}
 
%Пусть $\xi$ -- некоторая случайная величина, поставленная в соответствие доходности портфеля.
%Согласно работе Рокафеллера и Урясева \cite{Rock2000}, VaR уровня $\alpha$ для портфеля с прибылью $\mu_p$ определяется из формулы
%
%\begin{equation} \label{VaR}
%    \emph{VaR}_\alpha = \text{min}\{\zeta \in \mathbb{R}|P(\mu_p \le \zeta) \ge \alpha \},
%\end{equation}

%\noindent где $\zeta$ -- некоторое значение случайной величины $\xi$. CVaR уровня $\alpha$ определяется как
%
%\begin{equation} \label{ES}
%    \emph{CVaR}_\alpha = \mathbb{E}\left[\mu_p | \mu_p \le -\emph{VaR}_\alpha \right].
%\end{equation}

%Таким образом, с учётом уравнений (\ref{portretandrisk})--(\ref{ES}), задачу оптимизации портфеля можно сформировать следующим образом:

%\begin{eqnarray}\label{minES}
%\underset{\textbf{w}}{\text{minimize}} & & \emph{CVaR}_\alpha \\
%\text{subject to} & & \sum_{i=1}^d \mu_i w_i \ge \bar{\mu}_p \nonumber \\
%& & \sum_{i=1}^d w_i = 1 \nonumber \\
%& & w_i \ge 0. \nonumber
%\end{eqnarray}

%В данной формулировке введено также ограничение на минимальную доходность портфеля, обозначенная как $\bar{\mu}_p$.
%Таким образом, решением данной задачи оптимизации будет структура портфеля с минимальным значением ожидаемых с вероятностью $\alpha$ потерь и доходностью не меньше, чем значение $\bar{\mu}_p$.

\subsection{Алгоритм вычисления риск-метрик с использованием копул}

%В данной главе описывается алгоритм, основанный на моделировании псевдо-наблюдений методом Монте-Карло для вычисления риск метрик. 
%В качестве входных данных используются реальные псевдо-наблюдения и оценки параметров копул.

Приведем правило для нахождения риск-метрик методом исторического моделирования для эмпирических данных. 
Имея вектор \textbf{w} долей оптимального портфеля и массив лог-доходностей, можно найти ежедневную прибыль портфеля:
\begin{equation} \label{PnL}
    \text{P\&L}(t) = \sum_{i=1}^d w_i r_i(t)
\end{equation}

Согласно историческому методу моделирования VaR и CVaR могут быть вычислены по правилам:
\begin{gather}
    \emph{VaR}_\alpha = \mathbb{Q}_{-\text{P\&L}}  (\alpha),
    \label{VaR-hist} \\
	\emph{CVaR}_\alpha = \mathbb{E} (-\text{P\&L}|-\text{P\&L} > \emph{VaR}_\alpha).
	\label{ES-hist}
\end{gather}
%
%#Адекватность оценки VaR будем проверять с использованием теста Купича~\cite{Kupiec95}.

Для проверки адекватности полученных оценок~(\ref{VaR-hist}) будем использовать тест Купича \cite{Kupiec95, Travkin2013} на уровне 95\%, в котором в качестве основной выдвигается гипотеза $H_0$: оценка \emph{VaR} адекватная. 
Данный тест предполагает некоторую случайную величину $\xi$, имеющую биномиальное распределение с числом испытаний $m$ и вероятностью успеха $p$ в качестве параметров.


\begin{algorithm}[t]
\caption{Расчёт риск-метрик с использованием копул}
\label{Alg1}
\begin{algorithmic}[1]
	\Require Лог-доходности $\{r_{i,t}\}$, весовые коэффициенты $w_i$ оптимального портфеля, $i \in \overline{1,d}$, маргинальные распределения и параметры для каждого актив, $d$-мерная копула с известными параметрами, уровень $\alpha$ для вычисления $\emph{VaR}_\alpha$ и $\emph{CVaR}_\alpha$.
	\label{Alg1:input}
	\State Сгенерировать массив псевдо-наблюдений 
	$\{\hat{u}_{i,s}\} \in [0, 1]^d, \ i \in \overline{1,d}, \ s \in \overline{1, S}$ 
	в соответствии с выбранной копулой.\label{Alg1:simulation}
	\State Преобразовать сгенерированные псевдо-наблюдения в массив квантилей:
	\label{Alg1:transform:start}
	\For {$i \in \overline{1,d}$}
	    \For {$s \in \overline{1,S}$}
	        \State Вычислить $\hat{r}_{i,s}$ из ур.~(\ref{pobs-to-qtile}). \label{Alg1:transform}
	    \EndFor
	\EndFor \label{Alg1:transform:end}
	\State Вычислить ряд прибылей и потерь (P\&L) портфеля:
	\For {$s \in \overline{1,S}$} 
	\State Присвоить $\text{P\&L}(s) = \sum_{i=1}^d \hat{r}_{i,s} \cdot w_i$. \label{Alg1:PnL}
	\EndFor
	\State Вычислить $\emph{VaR}_\alpha$ и $\emph{CVaR}_\alpha$ из ур.~(\ref{VaR-hist})~и~(\ref{ES-hist}) соответственно. \label{Alg1:risk-measures}
	\Ensure VaR и CVaR для сгенерированных P\&L портфеля.
\end{algorithmic}
\end{algorithm}

Алгоритм~\ref{Alg1} описывает метод, который мы используем для вычисления VaR и CVaR с использованием копулярных моделей.
Метод основан на Монте-Карло генерации псевдо-наблюдений с использованием предложенных моделей копул и её оцененных параметров.
Данный алгоритм используется для каждого используемого в данной работе вида копул: Гауссовой, Стьюдента и R-вайн.

Для генерации массива случайных псевдо-наблюдений размерности \mbox{$S \times d$} (строка \ref{Alg1:simulation}) используются параметры, оценённые для каждого типа копул.
Параметры Гауссовой и Стьюдента копул указаны в уравнениях~(\ref{gausscopfit})~и~(\ref{tcopfit}), а структура вайн копулы -- в уравнении (\ref{vinefit}).
Затем полученные псевдо-наблюдения преобразуются в массив квантилей: $[0,1] \to \mathbb{R}$ (строки~\ref{Alg1:transform:start}~--~\ref{Alg1:transform:end}). Здесь необходимо использовать маргинальные распределения, полученные для каждого из активов (см. раздел~\ref{calibration:marginals}, табл.~\ref{tab:marginals}).
Для данного преобразования используется формула:
\begin{equation} \label{pobs-to-qtile}
    \hat{r}_{i,s} = F^{-1}_i (\hat{u}_{i,s}), \ \
    \forall i, s,
\end{equation}
где $F^{-1}_i (p)$ -- обратная квантильная функция вероятности маргинального распределения $i$-го актива, $S$ -- количество смоделированных сценариев, $i \in \overline{1,d}$, $s \in \overline{1,S}$.
В данном преобразовании сохраняется порядок переменных в каждой выборке сценариев.
Таким образом, в конечной выборке квантилей сохраняется зависимость между величинами.

Используя весовые коэффициенты CVaR-оптимального портфеля, вычисляется ряд P\&L портфеля (строка~\ref{Alg1:PnL}). Далее по формулам (\ref{VaR})~и~(\ref{ES}) оцениваются конечные риск метрики (строка~\ref{Alg1:risk-measures}).

\subsection{Бутстрап-процедура для получения несмещенной оценки риск-метрик}
\label{methodology:bootstrap}

Алгоритм~\ref{Alg1} позволяет получить оценку риска портфеля с помощью копулярных моделей для конкретной (единственной) реализации многомерной случайной величины. 
Однако во избежание получения %# не
смещённой оценки, которая может возникнуть на этапе Монте-Карло симуляции (шаг~\ref{Alg1:simulation}), предлагается использовать бутстрап-процедуру (алгоритм~\ref{Alg2}).
Суть её заключается в создании множества ($N$) выборок, полученных в результате Монте-Карло симуляций.

\begin{algorithm}[t]
\caption{Бутстрап-процедура для оценки риск-метрик}
\label{Alg2}
\begin{algorithmic}[1]
	\Require Число симуляций $N$, входные данные алгоритма~\ref{Alg1} (строка~\ref{Alg1:input}).
	\State Создать пустые векторы $\emph{VaR}_\alpha$ и $\emph{CVaR}_\alpha$.
	\For {$i \in \overline{1,N}$}
	    \State Запустить алгоритм~\ref{Alg1}
	    \State Добавить полученные значения $\emph{VaR}_{\alpha, i}$ и $\emph{CVaR}_{\alpha, i}$ к векторам $\emph{VaR}_\alpha$ и $\emph{CVaR}_\alpha$ соответственно.
	\EndFor
	\State Вычислить средние значения векторов $\emph{VaR}_\alpha$ и $\emph{CVaR}_\alpha$ (ур.~\ref{boot-mean}).
	\State Вычислить доверительный интервал векторов $\emph{VaR}_\alpha$ и $\emph{CVaR}_\alpha$ (ур.~\ref{boot-conf-area}).
	\State Вычислить смещение, SD и RMSE векторов $\emph{VaR}_\alpha$ и $\emph{CVaR}_\alpha$ (ур.~\ref{boot-bias}, \ref{boot-sd}, \ref{boot-rmse} соответственно).
	\Ensure Средние значения, доверительный интервал, характеристики ошибок оценок VaR и CVaR.
\end{algorithmic}
\end{algorithm}

Результатом такой процедуры будет набор из $N$ оценок, с помощью которого можно получить %#более
несмещенную оценку необходимой риск-метрики и найти для неё доверительный интервал. В данной работе мы ограничили этот интервал квантилями между вероятностями $2,5$ и $97,5\%$.
\begin{equation} \label{boot-conf-area}
    q^- = \mathbb{Q}_{\textbf{x}} (0.025), \ q^+ = \mathbb{Q}_{\textbf{x}} (0.975),
\end{equation}
где $\mathbb{Q}_{\textbf{x}} (p)$ -- эмпирическая квантиль вектора \textbf{x} на вероятности $p$, \textbf{x} -- вектор соответствующей риск-метрики, полученный в результате бутстрап-процедуры (алгоритм~\ref{Alg2}).

Пусть $\hat{x}$ -- значение риск-метрики, полученное историческим методом по эмпирическим наблюдениям из уравнений (\ref{VaR-hist})~и~(\ref{ES-hist}).
Полученные значения оценок риск-метрик сравниваются со значениями $\hat{x}$.
Среднее значение $\bar{x}$, смещение $\Delta$, стандартное отклонение SD (standard deviation) и средне-квадратичная ошибка RMSE (root-mean-square error) вычисляются соответственно по следующим формулам:
\begin{gather}
\bar{x} = \mathbb{E} (\textbf{x}) \approx \frac{1}{N} \sum_{i=1}^N x_i, \label{boot-mean} \\
\Delta = \bar{x} - \hat{x}, \label{boot-bias} \\
\text{SD} = \sqrt{\frac{1}{N-1} \sum_{i=1}^N (\bar{x} - x_i)^2}, \label{boot-sd} \\
\text{RMSE} = \sqrt{\frac{1}{N-1} \sum_{i=1}^N (\hat{x} - x_i)^2}. \label{boot-rmse}
\end{gather}

Заметим, что кроме бутстрап-процедуры также приведем  графическое представление кривых риск-метрик, которое позволяет визуально показать, насколько построенная модель оценки риска консервативна или агрессивна по отношению к эмпирическим данным и другим моделям. %#Подробнее см. главу~\ref{riskmeasures:curve}.